<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>wsSimpleDisplay</title>

		<!-- css needed for jquery UI -->
		<link href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" rel="stylesheet" type="text/css" /> 
		<!-- purecss simple css -->
		<link rel="stylesheet" href="https://unpkg.com/purecss@0.6.2/build/pure-min.css">
		<link rel="stylesheet" href="https://unpkg.com/purecss@0.6.2/build/grids-responsive-min.css">

		<script type="text/javascript" src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
		<script type="text/javascript" src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<style>
.right {
	text-align: right;
}

/* purecss border and padding */
.pure-g > div {
	-webkit-box-sizing: border-box;
	-moz-box-sizing: border-box;
	box-sizing: border-box;
}
.l-box {
	padding: 1em;
}
</style>
	</head>
	<body>

<script type="text/JavaScript">
var dataURL="http://cam.aprsworld.com:8888/data/now.json/A4753";

$.ajaxSetup({ cache: false }); 

/* extract filename after last / and before ? */
function filename(path){
	path = path.substring(path.lastIndexOf("/")+ 1);
	return (path.match(/[^.]+(\.[^?#]+)?/) || [])[0];
}

function loadNewData(){
	$.getJSON(dataURL, 
		function(data) {
			hideWarn();

			/* set the title of the page */
			$(document).attr("title", data.title + ": wsSimpleDisplay");

			/* iterate through data.sensors */
			$.each(data.sensors, function( index, value ) {
				if ( data.sensors[index].title !== undefined ) {
//						console.log( "data.sensors[" + index + "]: " + data.sensors[index].title + "=" + data.sensors[index].value);

					//Try to get tbody first with jquery children. works faster!
					var tbody = $('#autoData').children('tbody');


					var rowCode = '<tr id="autoData_' + index + '"><td class="right"><b>' + data.sensors[index].title + '</b></td><td>' + data.sensors[index].value + '</td><td>' + data.sensors[index].units + '</td></tr>';

					if ( $("#autoData_" + index).length ) {
						// replace row contents
						$("#autoData_" + index).replaceWith(rowCode);
					} else {
						console.log('adding row to table');
						tbody.append(rowCode);
					}

				}
			});

			$('#displayName').html(data.displayName);

			/* cameras */
			if (  data.cameras[0].image_url !== undefined ) {
				$("#camStatic0").attr("src", data.cameras[0].image_url);
				$("#camDisplayName0").html(data.camDisplayName0);
				/* $("#camURLPrimary0").html(data.camURLPrimary0); */
				/* $("#camURLPrimary0").attr("href", data.camURLPrimary0); */

				/* clickable download */
				$("#camStatic0_download").attr("href", data.cameras[0].image_url); 
				var downloadFilename=filename(dataURL) + "_0_" + filename(data.cameras[0].image_url);
				$("#camStatic0_download").attr("download",downloadFilename);

				$("#camStatic").show();
			} else {
				$("#camStatic").hide();
			}
		}
		); 

	setTimeout(loadNewData,5000);
}

function hideWarn(){
	$("#connection_warn").hide();
}

$(document).ready(function(){
	$.urlParam = function(name){
		var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
		if ( results==null ) {
			return null;
		} else {
			return results[1] || 0;
		}
	}

	if ( $.urlParam('dataURL') !== null && $.urlParam('dataURL').length ) {
		dataURL=$.urlParam('dataURL');
		console.log('Using data from: ' + dataURL + ' (as specified from URL parameter)');
	}

	/* setup AJAX data source */
	$( document ).ajaxError(function(event){
		console.log("no response from JSON server");
		$("#connection_warn").show();
		$("#connection_warn").append(event);
	});
	loadNewData();

	/* make auto data table sortable */
	$('#autoData').children('tbody').sortable({
		axis: 'y',
		update: function (event, ui) {
			var data = $(this).sortable('serialize');

			console.log('sortable serialize: ' + data);

			/* could do AJAX to send to server to store */
    	}
	});

	/* put dataURL on page */
	$("#spanDataURL").html(dataURL);


});
</script>
<div id="connection_warn" style="text-align: center; width: 800px; padding: 10px; margin-right: auto; margin-left: auto; background-color: orange; color: white; display: none;" onclick="hideWarn()">
	<h1>No Response From Server. Please check to make sure you are still connected to the internet</h1>
</div>

<div class="pure-g">

	<div class="pure-u-1 pure-u-sm-1-2 l-box">
<a id="camStatic0_download"><img class="pure-img" src="http://data.asrichards.com/images/logo.png" id="camStatic0" alt="Web Camera 0" /></a>
	</div>

	<div class="pure-u-1 pure-u-sm-1-2 l-box">
<table id="autoData" class="pure-table pure-table-horizontal pure-table-striped">
	<thead>
		<tr>
			<th>title</th>
			<th>value</th>
			<th>units</th>
		</tr>
	</thead>
	<tbody>
<!-- will insert data automatically here -->
	</tbody>
</table>
<!-- This table is sortable. Click and drag a row to re-order. -->
	</div>

<!-- below image and data we get a full width div -->
	<div class="pure-u-1 l-box">

<h1>Meta Data</h1>
Data source URL: <span id='spanDataURL'>loading</span>

	</div>
</div>
</body>
</html>
