<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>wsSimpleDisplay</title>

		<!-- css needed for jquery UI -->
		<link href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" rel="stylesheet" type="text/css" /> 
		<!-- purecss simple css -->
		<link rel="stylesheet" href="https://unpkg.com/purecss@0.6.2/build/pure-min.css">
		<link rel="stylesheet" href="https://unpkg.com/purecss@0.6.2/build/grids-responsive-min.css">

		<!-- jquery -->
		<script type="text/javascript" src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
		<!-- jquery UI - gives us sortable and icons -->
		<script type="text/javascript" src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
		<!-- jquery-popup-overlay - gives up popup & tooltips - http://dev.vast.com/jquery-popup-overlay/ -->
		<script src="https://cdn.rawgit.com/vast-engineering/jquery-popup-overlay/1.7.13/jquery.popupoverlay.js"></script>

		<!-- font awesome with info@aprsworld.com key -->
		<script src="https://use.fontawesome.com/269a99f1b2.js"></script>

		
		<style>
.right {
	text-align: right;
}

.debug {
	/* turned on with a URL parameter of debug=1 */
	color: red;
}

.edit {
	/* turned on with a URL parameter of edit=1 or by clicking edit button */
}

button {
	margin: 10px;
}

/* purecss border and padding */
.pure-g > div {
	-webkit-box-sizing: border-box;
	-moz-box-sizing: border-box;
	box-sizing: border-box;
}
.l-box {
	padding: 1em;
}
		</style>
	</head>
	<body>

<script type="text/JavaScript">
var dataURL="http://cam.aprsworld.com:8888/data/now.json/A4753";
var refreshSeconds=5;
var debug=false;
var edit=false;
//var hiddenDataID = ["48265c9ecebcb55c15662a5a66faa51a","00dac0c4199a50639db710d3c958908","0ca41badb637f4b03936f6d0e59e390c","cd836789f651b02071e05e045f9511b5"];
var hiddenDataID = [];

var stationID="";

/* don't cache ajax data */
$.ajaxSetup({ cache: false }); 

/* turn on or off page editing */
function pageEdit(editable) {
	console.log("# pageEdit(" + editable + ")");

	if ( editable ) {
		/* make page editable */

		/* edit button update label */
		$('#button-edit').html('Save Page');

		/* make auto data table sortable */
		$('#autoData').children('tbody').sortable({
			axis: 'y',
			update: function (event, ui) {
				var data = $(this).sortable('serialize');

				console.log('sortable serialize: ' + data);

				/* could do AJAX to send to server to store */
		    	}
		});

	} else {
		/* turn off editability */

	
		/* edit button update label */
		$('#button-edit').html('Edit Page');

		/* add CSS element for display: none to debug CSS */
/*
		$("head").append('<style type="text/css"></style>');
		var newStyleElement = $("head").children(':last');
		newStyleElement.html('.edit { display: none; }');
*/


	}

	/* set global variable */
	edit=editable;
}

/* extract filename after last / and before ? */
function filename(path){
	path = path.substring(path.lastIndexOf("/")+ 1);
	return (path.match(/[^.]+(\.[^?#]+)?/) || [])[0];
}

function hideRow() {
	/* find the table row ID that the button is in */
	var trid = $(this).closest('tr').attr('id');  
	/* find the table ID that the button is in */
	var tableid = $(this).closest('table').attr('id');  

	/* detach the row */
	var moving = $('#' + trid).detach();
	if ( "autoData" === tableid ) {
		/* attach the row to autoDataHidden */
		$("#autoDataHidden").append(moving);

		/* add to hidden data IDs array, if it isn't there already */
		if ( -1 == $.inArray(trid,hiddenDataID) ) {
			hiddenDataID.push(trid);
		}
	} else {
		/* attach the row to autoData */
		$("#autoData").append(moving);

		/* remove from hidden data IDs array */
		hiddenDataID.splice( $.inArray(trid, hiddenDataID), 1);
	}


	console.log('hideRow() tableid=' + tableid + ' trid=' + trid);

	$("#spanHiddenDataID").html(hiddenDataID.toString());
}

function loadNewData(){

	$.getJSON(dataURL, 
		function(data) {
			hideWarn();

			/* set the title of the page */
			if (  data.title !== undefined ) {
				$(document).attr("title", data.title + ": wsSimpleDisplay");
				$("#dataTitle").html(data.title);
			} else {
				$("#dataTitle").html(stationID + "<span style=\"font-size: 0.7em;\"><br />(site title not set)</span>");
			}

			/* iterate through data.sensors */
			$.each(data.sensors, function( index, value ) {
				if ( data.sensors[index].title !== undefined ) {
					/* find the table body for autoData */
					var tbody;

					if ( -1 != $.inArray(index,hiddenDataID) ) {
						/* autoDataHidden */
						tbody = $('#autoDataHidden').children('tbody');
					} else { 
						/* autoData */
						tbody = $('#autoData').children('tbody');
					}



					var rowCode = '<tr id="autoData_' + index + '"><td class="right"><span style="font-weight: bold;">' + data.sensors[index].title + '</span><span class="debug"><br />(' + index + ')</span></td><td>' + data.sensors[index].value + '</td><td>' + data.sensors[index].units + '&nbsp;<i class="edit fa fa-random"></i></td></tr>';

					if ( $("#autoData_" + index).length ) {
						/* replace row contents */
						$("#autoData_" + index).replaceWith(rowCode);
					} else {
						/* add row to table */
						console.log('adding row to table');
						tbody.append(rowCode);
					}

				}
			});
			/* call the hideRow() when we click on any icon with fa-random class */
			$(".fa-random").bind("click",hideRow);


//			$('#displayName').html(data.displayName);

			/* cameras */
			if (  data.cameras[0].image_url !== undefined ) {
				/* set the camera img src */
				$("#camStatic0").attr("src", data.cameras[0].image_url);

				/* full size image */
				/* $("#camURLPrimary0").html(data.camURLPrimary0); */
				/* $("#camURLPrimary0").attr("href", data.camURLPrimary0); */

				/* full size image clickable download (may not work in all browsers) */
/*
				$("#camStatic0_download").attr("href", data.cameras[0].image_url); 
				var downloadFilename=filename(dataURL) + "_0_" + filename(data.cameras[0].image_url);
				$("#camStatic0_download").attr("download",downloadFilename);
*/

				$("#camStatic").show();
			} else {
				$("#camStatic").hide();
			}
		}
		); 

	setTimeout(loadNewData,refreshSeconds*1000);
}

function hideWarn(){
	$("#connection_warn").hide();
}

$(document).ready(function(){
	/* put URL parameters into $.urlParam */
	$.urlParam = function(name){
		var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
		if ( results==null ) {
			return null;
		} else {
			return results[1] || 0;
		}
	}


	/* process URL parameters */
	if ( $.urlParam('dataURL') !== null && $.urlParam('dataURL').length ) {
		dataURL=$.urlParam('dataURL');
		console.log('# dataURL: ' + dataURL + ' (as specified from URL parameter)');
	}

	if ( $.urlParam('refreshSeconds') !== null && $.urlParam('refreshSeconds').length ) {
		refreshSeconds=$.urlParam('refreshSeconds');
		console.log('# refreshSeconds: ' + refreshSeconds + ' (as specified from URL parameter)');
	}

	if ( $.urlParam('debug') !== null && $.urlParam('debug').length && "1"===$.urlParam('debug') ) {
		debug=true;
		console.log('# debug: ' + debug + ' (as specified from URL parameter)');
	} else {
		/* add CSS element for display: none to debug CSS */
		$("head").append('<style type="text/css"></style>');
		var newStyleElement = $("head").children(':last');
		newStyleElement.html('.debug { display: none; }');
	}

	if ( $.urlParam('edit') !== null && $.urlParam('edit').length && "1"===$.urlParam('edit') ) {
		edit=true;
		console.log('# edit: ' + edit + ' (as specified from URL parameter)');
	}

	/* setup AJAX data source */
	$( document ).ajaxError(function(event){
		console.log("no response from JSON server");
		$("#connection_warn").show();
		$("#connection_warn").append(event);
	});
	loadNewData();

	/* put dataURL on page */
	$("#spanDataURL").html(dataURL);
	$("#spanDataURL").attr('href',dataURL);

	/* determine station ID */
	stationID=dataURL.split("/").pop();

	$("#spanRefreshSeconds").html(refreshSeconds);
//	$("#autoDataHidden").hide();

//	$("#delete_123").click(function() {

	/* setup page editability */
	pageEdit(edit);

	/* bind edit button */
	$('#button-edit').click( function () {
			pageEdit(!edit);
	});

	// Initialize the plugin
	$('#camera_popup').popup({
		type: 'tooltip',
		background: true,
		autozindex: true,
//		horizontal: 'leftedge',
		vertical: 'topedge',
		escape: true
	});

	$('.button-facebook').click( function() {
		var shareurl = window.location.href;
		window.open('https://www.facebook.com/sharer/sharer.php?u='+escape(shareurl)+'&t='+escape(document.title), '');
//, 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=600');
		return false;
	});

});
</script>
<div id="connection_warn" style="text-align: center; width: 800px; padding: 10px; margin-right: auto; margin-left: auto; background-color: orange; color: white; display: none;" onclick="hideWarn()">
	<h1>No Response From Server. Please check to make sure you are still connected to the Internet and have a valid data URL.</h1>
</div>


<!-- popup when clicking on camera image -->
<div id="camera_popup" style="background-color:rgba(255, 255, 255, 0.70); padding: 10px; border-radius: 10px; font-size: 2em;">
		<button type="button" id="button-fullsize" style="display: block; width: 95%;">
			<i class="fa fa-expand" aria-hidden="true" style="float: left; padding-top: 5px; padding-bottom: 5px; padding-right: 15px;"></i>
			<span style="float: right;">View Full Size</span>
		</button>

		<button type="button" id="button-download" style="display: block; width: 95%;">
			<i class="fa fa-download" aria-hidden="true" style="float: left; padding-top: 5px; padding-bottom: 5px; padding-right: 15px;"></i>
			<span style="float: right;">Download Image</span>
		</button>

		<button type="button" id="button-email" style="display: block; width: 95%;">
			<i class="fa fa-envelope" aria-hidden="true" style="float: left; padding-top: 5px; padding-bottom: 5px; padding-right: 15px;"></i>
			<span style="float: right;">E-mail Link</span>
		</button>

		<button type="button" class="button-facebook" style="display: block; width: 95%;">
			<i class="fa fa-facebook-official" aria-hidden="true" style="float: left; padding-top: 5px; padding-bottom: 5px; padding-right: 15px;"></i>
			<span style="float: right;">Facebook Share</span>
		</button>

		<button type="button" id="button-edit2" style="display: block; width: 95%;">
			<i class="fa fa-pencil" aria-hidden="true" style="float: left; padding-top: 5px; padding-bottom: 5px; padding-right: 15px;"></i>
			<span style="float: right;">Edit Page</span>
		</button>

		<button type="button" class="camera_popup_close" style="display: block; width: 95%;">
			<i class="fa fa-close" aria-hidden="true" style="float: left; padding-top: 5px; padding-bottom: 5px; padding-right: 15px;"></i>
			<span style="float: right;">Close Menu</span>
		</button>
</div>


<div class="pure-g">

	<div class="pure-u-1 pure-u-sm-1-2 l-box" id="divCamStatic0">
		<a id="camStatic0_a" class="camera_popup_open"><img class="pure-img" src="http://www.aprsworld.com/images/logo_250.png" id="camStatic0" alt="Web Camera 0" /></a>

	</div>

	<div class="pure-u-1 pure-u-sm-1-2 l-box">
<table id="autoData" class="pure-table pure-table-horizontal pure-table-striped">
	<thead>
		<tr>
			<th colspan="3" id="dataTitle" style="text-align: center"></th>
		</tr>
	</thead>
	<tbody>
<!-- will insert data automatically here -->
	</tbody>
</table>

<h2>Hidden Rows</h2>
<table id="autoDataHidden" class="pure-table pure-table-horizontal pure-table-striped">
	<thead>
		<tr>
			<th>title</th>
			<th>value</th>
			<th>units</th>
		</tr>
	</thead>
	<tbody>
<!-- will insert data automatically here -->
	</tbody>
</table>
	</div>


<!-- below image and data we get a full width div -->
	<div class="pure-u-1 l-box">

<h1>Meta Data</h1>
<ul>
	<li>dataURL=<a href="" id='spanDataURL'>loading</a></li>
	<li>refreshSeconds: <span id='spanRefreshSeconds'>loading</li>
	<li>hiddenDataID: <span id='spanHiddenDataID'>loading</li>
</ul>

	</div>
</div>
</body>
</html>
